{% extends 'request/index.html' %} 
{% load static %}
{% load tz %} 
{% block left_nav %}
<li>
  <a href="/queue/">
    <i class="fa fa-book"></i><span>Queue</span>
  </a>
</li>
{% endblock %}
{% block notification %}

<li class="dropdown messages-menu" >
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
    <i class="fa fa-envelope-o"></i>
    <span id="myspan" class="label label-success"></span>
  </a>
  <ul id="dynamic-list" class="dropdown-menu"></ul>
</li>
<!-- 
<div class="navbar-custom-menu pull-left">
    <ul class="nav navbar-nav">
      <li class="dropdown user user-menu">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span class="glyphicon glyphicon-envelope">
          </span>
        </a>
        <ul id="dynamic-list1" class="dp-menu" aria-labelledby="dropdownMenu1">
        </ul>
      </li>
    </ul>
  </div> -->
{% endblock %}
{% block script %}
<script>
    var ul = document.getElementById("dynamic-list");
    var notification = document.getElementById("myspan");
    const url = "/inbox/notifications/api/unread_list/";
    $.getJSON(url, function (data) {
      unread_count=data.unread_count
      unread_list=data.unread_list
      notification.innerHTML=unread_count
      $.each(unread_list, function (key, entry) {
        var li = document.createElement("li");
        var a = document.createElement("a");
        a.textContent = entry.verb;
        
        var case1=entry.data;
        var case_id=case1["incident"];
        var url1="/request/"+case_id+"/";
        li.setAttribute('value',url1);
        a.setAttribute('id',entry.id);
        a.setAttribute('value',url1);
        a.setAttribute('href',"#/");
        a.setAttribute('onclick','mark_as_read()');
        li.appendChild(a);
        ul.appendChild(li);
        
      })
    });
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = jQuery.trim(cookies[i]);
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');
  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
    function mark_as_read(){
      $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      }
    });
    notification_id=$(this).attr('id');
    console.log(notification_id);
    $.ajax({
      url: "/api/notification/"+notification_id+"/",
      type : 'PATCH',
      dataType: 'json',
      data: {
        'unread': false,
      },
      statusCode: {
        200: function() {
          window.location.href = $(this).value;
        }
      },
    });
    }
  </script>
{% endblock %}